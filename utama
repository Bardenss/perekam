-- Replay recorder (iOS friendly - memory + clipboard only + rename + delete + Lua export)
local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")

player.CharacterAdded:Connect(function(newChar)
    char = newChar
    hrp = char:WaitForChild("HumanoidRootPart")
end)

local HttpService = game:GetService("HttpService")
local records = {}
local isRecording = false
local isPlaying = false
local frameTime = 1/30 -- 30 FPS
local replayList = {} -- simpan replay di memori

-- ===== Recording =====
function startRecord()
    if isRecording then return end
    records = {}
    isRecording = true
    if recordBtn then recordBtn.Text = "⏸ Pause Record" end

    task.spawn(function()
        while isRecording do
            if hrp then
                table.insert(records, { pos = hrp.CFrame })
            end
            task.wait(frameTime)
        end
    end)
end

function stopRecord()
    if not isRecording then return end
    isRecording = false
    if recordBtn then recordBtn.Text = "⏺ Start Record" end

    if #records > 0 then
        local name = os.date("Replay_%H%M%S.json")
        replayList[name] = table.clone(records)
        print("✅ Replay disimpan ke list:", name, "Frames:", #records)
        refreshReplayList()
    end
end

-- ===== Playback =====
function playRecord()
    if #records < 2 then
        warn("❌ Tidak ada replay yang dimuat/rekaman terlalu pendek.")
        return
    end
    isPlaying = true
    for i = 1, #records-1 do
        if not isPlaying then break end
        local startPos = records[i].pos
        local endPos = records[i+1].pos
        local t = 0
        while t < frameTime do
            if not isPlaying then break end
            t += task.wait()
            local alpha = math.min(t/frameTime, 1)
            if hrp and hrp.Parent and hrp:IsDescendantOf(workspace) then
                hrp.CFrame = startPos:Lerp(endPos, alpha)
            end
        end
    end
    isPlaying = false
end

function stopPlay()
    isPlaying = false
end

-- ===== Export ke Lua Format =====
local function encodeRecordsToLua(rec)
    local lines = {"return {"}
    for _, frame in ipairs(rec) do
        local pos = frame.pos.Position
        local rotX, rotY, rotZ = frame.pos:ToOrientation()
        table.insert(lines,
            string.format("    CFrame.new(%.15f,%.15f,%.15f) * CFrame.Angles(%.15f,%.15f,%.15f),",
            pos.X, pos.Y, pos.Z, rotX, rotY, rotZ)
        )
    end
    table.insert(lines, "}")
    return table.concat(lines, "\n")
end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.ResetOnSpawn = false
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 260, 0, 380)
frame.Position = UDim2.new(0, 20, 0.5, -190)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

local function makeBtn(ref, text, pos, callback, color)
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(1, -20, 0, 34)
    btn.Position = UDim2.new(0, 10, 0, pos)
    btn.Text = text
    btn.BackgroundColor3 = color or Color3.fromRGB(0, 170, 255)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    btn.MouseButton1Click:Connect(callback)
    if ref then
        _G[ref] = btn
    end
    return btn
end

recordBtn = makeBtn("recordBtn", "⏺ Start Record", 50, function()
    if isRecording then
        stopRecord()
    else
        startRecord()
    end
end)

makeBtn(nil, "▶️ Play Replay", 100, playRecord)
makeBtn(nil, "⏹ Stop Replay", 150, stopPlay)

-- ===== Replay List Window =====
local replayFrame
function refreshReplayList()
    if replayFrame then replayFrame:Destroy() end
    replayFrame = Instance.new("Frame", gui)
    replayFrame.Size = UDim2.new(0, 320, 0, 320) -- lebih lebar biar muat tombol
    replayFrame.Position = UDim2.new(0, 300, 0.5, -160)
    replayFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
    replayFrame.Active = true
    replayFrame.Draggable = true
    Instance.new("UICorner", replayFrame).CornerRadius = UDim.new(0, 10)

    local closeBtn = Instance.new("TextButton", replayFrame)
    closeBtn.Size = UDim2.new(0, 50, 0, 25)
    closeBtn.Position = UDim2.new(1, -55, 0, 5)
    closeBtn.Text = "X"
    closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
    closeBtn.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0,4)
    closeBtn.MouseButton1Click:Connect(function()
        replayFrame:Destroy()
        replayFrame = nil
    end)

    local yPos = 35
    for name, rec in pairs(replayList) do
        -- Nama replay (bisa diklik untuk load)
        local btn = Instance.new("TextButton", replayFrame)
        btn.Size = UDim2.new(0.55, -10, 0, 30)
        btn.Position = UDim2.new(0, 10, 0, yPos)
        btn.Text = name
        btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

        btn.MouseButton1Click:Connect(function()
            records = table.clone(rec)
            print("✅ Loaded replay:", name, "Frames:", #records)
        end)

        -- RENAME
        local renameBtn = Instance.new("TextButton", replayFrame)
        renameBtn.Size = UDim2.new(0, 50, 0, 30)
        renameBtn.Position = UDim2.new(0.55, 0, 0, yPos)
        renameBtn.Text = "REN"
        renameBtn.BackgroundColor3 = Color3.fromRGB(0,120,255)
        renameBtn.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", renameBtn).CornerRadius = UDim.new(0,6)
        renameBtn.MouseButton1Click:Connect(function()
            local newName = "Replay_"..os.date("%H%M%S")..".json"
            replayList[newName] = rec
            replayList[name] = nil
            print("✏️ Rename:", name, "➡️", newName)
            refreshReplayList()
        end)

        -- COPY
        local copyBtn = Instance.new("TextButton", replayFrame)
        copyBtn.Size = UDim2.new(0, 60, 0, 30)
        copyBtn.Position = UDim2.new(0.55, 55, 0, yPos)
        copyBtn.Text = "COPY"
        copyBtn.BackgroundColor3 = Color3.fromRGB(50,200,50)
        copyBtn.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", copyBtn).CornerRadius = UDim.new(0,6)
        copyBtn.MouseButton1Click:Connect(function()
            local exportText = encodeRecordsToLua(rec)
            if setclipboard then
                setclipboard(exportText)
                print("✅ Replay exported to clipboard (Lua format):", name)
            else
                warn("❌ setclipboard() tidak tersedia di exploit ini.")
            end
        end)

        -- DEL
        local delBtn = Instance.new("TextButton", replayFrame)
        delBtn.Size = UDim2.new(0, 50, 0, 30)
        delBtn.Position = UDim2.new(1, -60, 0, yPos)
        delBtn.Text = "DEL"
        delBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
        delBtn.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", delBtn).CornerRadius = UDim.new(0,6)
        delBtn.MouseButton1Click:Connect(function()
            replayList[name] = nil
            print("🗑️ Replay dihapus:", name)
            refreshReplayList()
        end)

        yPos = yPos + 40
    end
end

makeBtn(nil, "📂 Open Replay List", 200, refreshReplayList, Color3.fromRGB(255,170,0))

-- ===== Info =====
spawn(function()
    wait(0.2)
    print("ℹ️ Cara pakai: Start → Stop → replay otomatis muncul di list. Dari list bisa Load, Rename, Copy (Lua), atau Delete.")
end)
